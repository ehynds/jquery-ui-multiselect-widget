/*
 * jQuery MultiSelect UI Widget 1.13
 * Copyright (c) 2012 Eric Hynds
 *
 * http://www.erichynds.com/jquery/jquery-ui-multiselect-widget/
 *
 * Fork: https://github.com/enkarito/jquery-ui-multiselect-widget
 * Author: Leonid Shumakov
 *
 * Depends:
 *   - jQuery 1.4.2+
 *   - jQuery UI 1.8 widget factory
 *
 * Optional:
 *   - jQuery UI effects
 *   - jQuery UI position utility
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(e,t){var n=0;var r=e(document);e.widget("ech.multiselect",{options:{header:true,height:175,minWidth:225,classes:"",checkAllText:"Check all",uncheckAllText:"Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",selectedList:0,show:null,hide:null,autoOpen:false,multiple:true,position:{},appendTo:"body"},_create:function(){var t=this.element.hide();var r=this.options;this.speed=e.fx.speeds._default;this._isOpen=false;this._namespaceID=this.eventNamespace||"multiselect"+n;var i=(this.button=e('<button type="button"><span class="ui-icon ui-icon-triangle-1-s"></span></button>')).addClass("ui-multiselect ui-widget ui-state-default ui-corner-all").addClass(r.classes).attr({title:t.attr("title"),"aria-haspopup":true,tabIndex:t.attr("tabIndex")}).insertAfter(t),s=(this.buttonlabel=e("<span />")).html(r.noneSelectedText).appendTo(i),o=(this.menu=e("<div />")).addClass("ui-multiselect-menu ui-widget ui-widget-content ui-corner-all").addClass(r.classes).appendTo(e(r.appendTo)),u=(this.header=e("<div />")).addClass("ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix").appendTo(o),a=(this.headerLinkContainer=e("<ul />")).addClass("ui-helper-reset").html(function(){if(r.header===true){return'<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+r.checkAllText+'</span></a></li><li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+r.uncheckAllText+"</span></a></li>"}else if(typeof r.header==="string"){return"<li>"+r.header+"</li>"}else{return""}}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="ui-icon ui-icon-circle-close"></span></a></li>').appendTo(u),f=(this.checkboxContainer=e("<ul />")).addClass("ui-multiselect-checkboxes ui-helper-reset").appendTo(o);this._bindEvents();this.refresh(true);if(!r.multiple){o.addClass("ui-multiselect-single")}n++},_init:function(){if(this.options.header===false){this.header.hide()}if(!this.options.multiple){this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide()}if(this.options.autoOpen){this.open()}if(this.element.is(":disabled")){this.disable()}},refresh:function(t){var r=this.element;var i=this.options;var s=this.menu;var o=this.checkboxContainer;var u=[];var a="";var f=r.attr("id")||n++;r.find("option").each(function(t){var n=e(this);var r=this.parentNode;var s=this.innerHTML;var o=this.title;var l=this.value;var c="ui-multiselect-"+(this.id||f+"-option-"+t);var h=this.disabled;var p=this.selected;var d=["ui-corner-all"];var v=(h?"ui-multiselect-disabled ":" ")+this.className;var m;if(r.tagName==="OPTGROUP"){m=r.getAttribute("label");if(e.inArray(m,u)===-1){var g=m.replace(/&/g,"&").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/'/g,"&#39;").replace(/\//g,"&#x2F;").replace(/"/g,"&quot;");a+='<li class="ui-multiselect-optgroup-label '+r.className+'"><a href="#">'+g+"</a></li>";u.push(m)}}if(h){d.push("ui-state-disabled")}if(p&&!i.multiple){d.push("ui-state-active")}a+='<li class="'+v+'">';a+='<label for="'+c+'" title="'+o+'" class="'+d.join(" ")+'">';a+='<input id="'+c+'" name="multiselect_'+f+'" type="'+(i.multiple?"checkbox":"radio")+'" value="'+l+'" title="'+o+'"';if(p){a+=' checked="checked"';a+=' aria-selected="true"'}if(h){a+=' disabled="disabled"';a+=' aria-disabled="true"'}a+=" /><span>"+s+"</span></label></li>"});o.html(a);this.labels=s.find("label");this.inputs=this.labels.children("input");this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();if(!t){this._trigger("refresh")}},update:function(){var t=this.options;var n=this.inputs;var r=n.filter(":checked");var i=r.length;var s;if(i===0){s=t.noneSelectedText}else{if(e.isFunction(t.selectedText)){s=t.selectedText.call(this,i,n.length,r.get())}else if(/\d/.test(t.selectedList)&&t.selectedList>0&&i<=t.selectedList){s=r.map(function(){return e(this).next().html()}).get().join(", ")}else{s=t.selectedText.replace("#",i).replace("#",n.length)}}this._setButtonValue(s);return s},_setButtonValue:function(e){this.buttonlabel.text(e)},_bindEvents:function(){function i(){t[t._isOpen?"close":"open"]();return false}var t=this;var n=this.button;n.find("span").bind("click.multiselect",i);n.bind({click:i,keypress:function(e){switch(e.which){case 27:case 38:case 37:t.close();break;case 39:case 40:t.open();break}},mouseenter:function(){if(!n.hasClass("ui-state-disabled")){e(this).addClass("ui-state-hover")}},mouseleave:function(){e(this).removeClass("ui-state-hover")},focus:function(){if(!n.hasClass("ui-state-disabled")){e(this).addClass("ui-state-focus")}},blur:function(){e(this).removeClass("ui-state-focus")}});this.header.delegate("a","click.multiselect",function(n){if(e(this).hasClass("ui-multiselect-close")){t.close()}else{t[e(this).hasClass("ui-multiselect-all")?"checkAll":"uncheckAll"]()}n.preventDefault()});this.menu.delegate("li.ui-multiselect-optgroup-label a","click.multiselect",function(n){n.preventDefault();var r=e(this);var i=r.parent().nextUntil("li.ui-multiselect-optgroup-label").find("input:visible:not(:disabled)");var s=i.get();var o=r.parent().text();if(t._trigger("beforeoptgrouptoggle",n,{inputs:s,label:o})===false){return}t._toggleChecked(i.filter(":checked").length!==i.length,i);t._trigger("optgrouptoggle",n,{inputs:s,label:o,checked:s[0].checked})}).delegate("label","mouseenter.multiselect",function(){if(!e(this).hasClass("ui-state-disabled")){t.labels.removeClass("ui-state-hover");e(this).addClass("ui-state-hover").find("input").focus()}}).delegate("label","keydown.multiselect",function(n){n.preventDefault();switch(n.which){case 9:case 27:t.close();break;case 38:case 40:case 37:case 39:t._traverse(n.which,this);break;case 13:e(this).find("input")[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]',"click.multiselect",function(n){var r=e(this);var i=this.value;var s=this.checked;var o=t.element.find("option");if(this.disabled||t._trigger("click",n,{value:i,text:this.title,checked:s})===false){n.preventDefault();return}r.focus();r.attr("aria-selected",s);o.each(function(){if(this.value===i){this.selected=s}else if(!t.options.multiple){this.selected=false}});if(!t.options.multiple){t.labels.removeClass("ui-state-active");r.closest("label").toggleClass("ui-state-active",s);t.close()}t.element.trigger("change");setTimeout(e.proxy(t.update,t),10)});r.bind("mousedown."+this._namespaceID,function(n){var r=n.target;if(t._isOpen&&r!==t.button[0]&&r!==t.menu[0]&&!e.contains(t.menu[0],r)&&!e.contains(t.button[0],r)){t.close()}});e(this.element[0].form).bind("reset.multiselect",function(){setTimeout(e.proxy(t.refresh,t),10)})},_setButtonWidth:function(){var e=this.element.outerWidth();var t=this.options;if(/\d/.test(t.minWidth)&&e<t.minWidth){e=t.minWidth}this.button.outerWidth(e)},_setMenuWidth:function(){var e=this.menu;e.outerWidth(this.button.outerWidth())},_traverse:function(t,n){var r=e(n);var i=t===38||t===37;var s=r.parent()[i?"prevAll":"nextAll"]("li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)").first();if(!s.length){var o=this.menu.find("ul").last();this.menu.find("label")[i?"last":"first"]().trigger("mouseover");o.scrollTop(i?o.height():0)}else{s.find("label").trigger("mouseover")}},_toggleState:function(e,t){return function(){if(!this.disabled){this[e]=t}if(t){this.setAttribute("aria-selected",true)}else{this.removeAttribute("aria-selected")}}},_toggleChecked:function(t,n){var r=n&&n.length?n:this.inputs;var i=this;r.each(this._toggleState("checked",t));r.eq(0).focus();this.update();var s=r.map(function(){return this.value}).get();this.element.find("option").each(function(){if(!this.disabled&&e.inArray(this.value,s)>-1){i._toggleState("selected",t).call(this)}});if(r.length){this.element.trigger("change")}},_toggleDisabled:function(t){this.button.attr({disabled:t,"aria-disabled":t})[t?"addClass":"removeClass"]("ui-state-disabled");var n=this.menu.find("input");var r="ech-multiselect-disabled";if(t){n=n.filter(":enabled").data(r,true)}else{n=n.filter(function(){return e.data(this,r)===true}).removeData(r)}n.attr({disabled:t,"arial-disabled":t}).parent()[t?"addClass":"removeClass"]("ui-state-disabled");this.element.attr({disabled:t,"aria-disabled":t})},open:function(t){var n=this;var r=this.button;var i=this.menu;var s=this.speed;var o=this.options;var u=[];if(this._trigger("beforeopen")===false||r.hasClass("ui-state-disabled")||this._isOpen){return}var a=i.find("ul").last();var f=o.show;if(e.isArray(o.show)){f=o.show[0];s=o.show[1]||n.speed}if(f){u=[f,s]}a.scrollTop(0).height(o.height);this.position();e.fn.show.apply(i,u);this.labels.filter(":not(.ui-state-disabled)").eq(0).trigger("mouseover").trigger("mouseenter").find("input").trigger("focus");r.addClass("ui-state-active");this._isOpen=true;this._trigger("open")},close:function(){if(this._trigger("beforeclose")===false){return}var t=this.options;var n=t.hide;var r=this.speed;var i=[];if(e.isArray(t.hide)){n=t.hide[0];r=t.hide[1]||this.speed}if(n){i=[n,r]}e.fn.hide.apply(this.menu,i);this.button.removeClass("ui-state-active").trigger("blur").trigger("mouseleave");this._isOpen=false;this._trigger("close")},enable:function(){this._toggleDisabled(false)},disable:function(){this._toggleDisabled(true)},checkAll:function(e){this._toggleChecked(true);this._trigger("checkAll")},uncheckAll:function(){this._toggleChecked(false);this._trigger("uncheckAll")},getChecked:function(){return this.menu.find("input").filter(":checked")},destroy:function(){e.Widget.prototype.destroy.call(this);r.unbind(this._namespaceID);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},getButton:function(){return this.button},position:function(){var t=this.options;if(e.ui.position&&!e.isEmptyObject(t.position)){t.position.of=t.position.of||this.button;this.menu.show().position(t.position).hide()}else{var n=this.button.offset();this.menu.css({top:n.top+this.button.outerHeight(),left:n.left})}},_setOption:function(t,n){var r=this.menu;switch(t){case"header":r.find("div.ui-multiselect-header")[n?"show":"hide"]();break;case"checkAllText":r.find("a.ui-multiselect-all span").eq(-1).text(n);break;case"uncheckAllText":r.find("a.ui-multiselect-none span").eq(-1).text(n);break;case"height":r.find("ul").last().height(parseInt(n,10));break;case"minWidth":this.options[t]=parseInt(n,10);this._setButtonWidth();this._setMenuWidth();break;case"selectedText":case"selectedList":case"noneSelectedText":this.options[t]=n;this.update();break;case"classes":r.add(this.button).removeClass(this.options.classes).addClass(n);break;case"multiple":r.toggleClass("ui-multiselect-single",!n);this.options.multiple=n;this.element[0].multiple=n;this.refresh();break;case"position":this.position()}e.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery)
