/*
 * jQuery MultiSelect UI Widget 1.13
 * Copyright (c) 2012 Eric Hynds
 *
 * http://www.erichynds.com/jquery/jquery-ui-multiselect-widget/
 *
 * Fork: https://github.com/enkarito/jquery-ui-multiselect-widget
 * Author: Leonid Shumakov
 *
 * Depends:
 *   - jQuery 1.4.2+
 *   - jQuery UI 1.8 widget factory
 *
 * Optional:
 *   - jQuery UI effects
 *   - jQuery UI position utility
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function(b,c){var a=0;var d=b(document);b.widget("ech.multiselect",{options:{header:true,height:175,minWidth:225,classes:"",checkAllText:"Check all",uncheckAllText:"Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",selectedList:0,show:null,hide:null,autoOpen:false,multiple:true,position:{},appendTo:"body"},_create:function(){var h=this.element.hide();var j=this.options;this.speed=b.fx.speeds._default;this._isOpen=false;this._namespaceID=this.eventNamespace||("multiselect"+a);var g=(this.button=b('<button type="button"><span class="ui-icon ui-icon-triangle-1-s"></span></button>')).addClass("ui-multiselect ui-widget ui-state-default ui-corner-all").addClass(j.classes).attr({title:h.attr("title"),"aria-haspopup":true,tabIndex:h.attr("tabIndex")}).insertAfter(h),e=(this.buttonlabel=b("<span />")).html(j.noneSelectedText).appendTo(g),i=(this.menu=b("<div />")).addClass("ui-multiselect-menu ui-widget ui-widget-content ui-corner-all").addClass(j.classes).appendTo(b(j.appendTo)),l=(this.header=b("<div />")).addClass("ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix").appendTo(i),f=(this.headerLinkContainer=b("<ul />")).addClass("ui-helper-reset").html(function(){if(j.header===true){return'<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+j.checkAllText+'</span></a></li><li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+j.uncheckAllText+"</span></a></li>"}else{if(typeof j.header==="string"){return"<li>"+j.header+"</li>"}else{return""}}}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="ui-icon ui-icon-circle-close"></span></a></li>').appendTo(l),k=(this.checkboxContainer=b("<ul />")).addClass("ui-multiselect-checkboxes ui-helper-reset").appendTo(i);this._bindEvents();this.refresh(true);if(!j.multiple){i.addClass("ui-multiselect-single")}a++},_init:function(){if(this.options.header===false){this.header.hide()}if(!this.options.multiple){this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide()}if(this.options.autoOpen){this.open()}if(this.element.is(":disabled")){this.disable()}},refresh:function(j){var g=this.element;var i=this.options;var h=this.menu;var l=this.checkboxContainer;var e=[];var f="";var k=g.attr("id")||a++;g.find("option").each(function(o){var p=b(this);var v=this.parentNode;var x=this.innerHTML;var t=this.title;var u=this.value;var n="ui-multiselect-"+(this.id||k+"-option-"+o);var y=this.disabled;var m=this.selected;var s=["ui-corner-all"];var r=(y?"ui-multiselect-disabled ":" ")+this.className;var w;if(v.tagName==="OPTGROUP"){w=v.getAttribute("label");if(b.inArray(w,e)===-1){var q=w.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/'/g,"&#39;").replace(/\//g,"&#x2F;").replace(/"/g,"&quot;");f+='<li class="ui-multiselect-optgroup-label '+v.className+'"><a href="#">'+q+"</a></li>";e.push(w)}}if(y){s.push("ui-state-disabled")}if(m&&!i.multiple){s.push("ui-state-active")}f+='<li class="'+r+'">';f+='<label for="'+n+'" title="'+t+'" class="'+s.join(" ")+'">';f+='<input id="'+n+'" name="multiselect_'+k+'" type="'+(i.multiple?"checkbox":"radio")+'" value="'+u+'" title="'+t+'"';if(m){f+=' checked="checked"';f+=' aria-selected="true"'}if(y){f+=' disabled="disabled"';f+=' aria-disabled="true"'}f+=" /><span>"+x+"</span></label></li>"});l.html(f);this.labels=h.find("label");this.inputs=this.labels.children("input");this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();if(!j){this._trigger("refresh")}},update:function(){var i=this.options;var f=this.inputs;var e=f.filter(":checked");var g=e.length;var h;if(g===0){h=i.noneSelectedText}else{if(b.isFunction(i.selectedText)){h=i.selectedText.call(this,g,f.length,e.get())}else{if(/\d/.test(i.selectedList)&&i.selectedList>0&&g<=i.selectedList){h=e.map(function(){return b(this).next().html()}).get().join(", ")}else{h=i.selectedText.replace("#",g).replace("#",f.length)}}}this._setButtonValue(h);return h},_setButtonValue:function(e){this.buttonlabel.text(e)},_bindEvents:function(){var e=this;var f=this.button;function g(){e[e._isOpen?"close":"open"]();return false}f.find("span").bind("click.multiselect",g);f.bind({click:g,keypress:function(h){switch(h.which){case 27:case 38:case 37:e.close();break;case 39:case 40:e.open();break}},mouseenter:function(){if(!f.hasClass("ui-state-disabled")){b(this).addClass("ui-state-hover")}},mouseleave:function(){b(this).removeClass("ui-state-hover")},focus:function(){if(!f.hasClass("ui-state-disabled")){b(this).addClass("ui-state-focus")}},blur:function(){b(this).removeClass("ui-state-focus")}});this.header.delegate("a","click.multiselect",function(h){if(b(this).hasClass("ui-multiselect-close")){e.close()}else{e[b(this).hasClass("ui-multiselect-all")?"checkAll":"uncheckAll"]()}h.preventDefault()});this.menu.delegate("li.ui-multiselect-optgroup-label a","click.multiselect",function(l){l.preventDefault();var k=b(this);var j=k.parent().nextUntil("li.ui-multiselect-optgroup-label").find("input:visible:not(:disabled)");var h=j.get();var i=k.parent().text();if(e._trigger("beforeoptgrouptoggle",l,{inputs:h,label:i})===false){return}e._toggleChecked(j.filter(":checked").length!==j.length,j);e._trigger("optgrouptoggle",l,{inputs:h,label:i,checked:h[0].checked})}).delegate("label","mouseenter.multiselect",function(){if(!b(this).hasClass("ui-state-disabled")){e.labels.removeClass("ui-state-hover");b(this).addClass("ui-state-hover").find("input").focus()}}).delegate("label","keydown.multiselect",function(h){h.preventDefault();switch(h.which){case 9:case 27:e.close();break;case 38:case 40:case 37:case 39:e._traverse(h.which,this);break;case 13:b(this).find("input")[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]',"click.multiselect",function(k){var j=b(this);var l=this.value;var i=this.checked;var h=e.element.find("option");if(this.disabled||e._trigger("click",k,{value:l,text:this.title,checked:i})===false){k.preventDefault();return}j.focus();j.attr("aria-selected",i);h.each(function(){if(this.value===l){this.selected=i}else{if(!e.options.multiple){this.selected=false}}});if(!e.options.multiple){e.labels.removeClass("ui-state-active");j.closest("label").toggleClass("ui-state-active",i);e.close()}e.element.trigger("change");setTimeout(b.proxy(e.update,e),10)});d.bind("mousedown."+this._namespaceID,function(h){var i=h.target;if(e._isOpen&&i!==e.button[0]&&i!==e.menu[0]&&!b.contains(e.menu[0],i)&&!b.contains(e.button[0],i)){e.close()}});b(this.element[0].form).bind("reset.multiselect",function(){setTimeout(b.proxy(e.refresh,e),10)})},_setButtonWidth:function(){var e=this.element.outerWidth();var f=this.options;if(/\d/.test(f.minWidth)&&e<f.minWidth){e=f.minWidth}this.button.outerWidth(e)},_setMenuWidth:function(){var e=this.menu;e.outerWidth(this.button.outerWidth())},_traverse:function(i,j){var g=b(j);var f=i===38||i===37;var e=g.parent()[f?"prevAll":"nextAll"]("li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)").first();if(!e.length){var h=this.menu.find("ul").last();this.menu.find("label")[f?"last":"first"]().trigger("mouseover");h.scrollTop(f?h.height():0)}else{e.find("label").trigger("mouseover")}},_toggleState:function(f,e){return function(){if(!this.disabled){this[f]=e}if(e){this.setAttribute("aria-selected",true)}else{this.removeAttribute("aria-selected")}}},_toggleChecked:function(e,i){var h=(i&&i.length)?i:this.inputs;var g=this;h.each(this._toggleState("checked",e));h.eq(0).focus();this.update();var f=h.map(function(){return this.value}).get();this.element.find("option").each(function(){if(!this.disabled&&b.inArray(this.value,f)>-1){g._toggleState("selected",e).call(this)}});if(h.length){this.element.trigger("change")}},_toggleDisabled:function(f){this.button.attr({disabled:f,"aria-disabled":f})[f?"addClass":"removeClass"]("ui-state-disabled");var e=this.menu.find("input");var g="ech-multiselect-disabled";if(f){e=e.filter(":enabled").data(g,true)}else{e=e.filter(function(){return b.data(this,g)===true}).removeData(g)}e.attr({disabled:f,"arial-disabled":f}).parent()[f?"addClass":"removeClass"]("ui-state-disabled");this.element.attr({disabled:f,"aria-disabled":f})},open:function(j){var m=this;var i=this.button;var f=this.menu;var h=this.speed;var g=this.options;var k=[];if(this._trigger("beforeopen")===false||i.hasClass("ui-state-disabled")||this._isOpen){return}var l=f.find("ul").last();var n=g.show;if(b.isArray(g.show)){n=g.show[0];h=g.show[1]||m.speed}if(n){k=[n,h]}l.scrollTop(0).height(g.height);this.position();b.fn.show.apply(f,k);this.labels.filter(":not(.ui-state-disabled)").eq(0).trigger("mouseover").trigger("mouseenter").find("input").trigger("focus");i.addClass("ui-state-active");this._isOpen=true;this._trigger("open")},close:function(){if(this._trigger("beforeclose")===false){return}var h=this.options;var f=h.hide;var g=this.speed;var e=[];if(b.isArray(h.hide)){f=h.hide[0];g=h.hide[1]||this.speed}if(f){e=[f,g]}b.fn.hide.apply(this.menu,e);this.button.removeClass("ui-state-active").trigger("blur").trigger("mouseleave");this._isOpen=false;this._trigger("close")},enable:function(){this._toggleDisabled(false)},disable:function(){this._toggleDisabled(true)},checkAll:function(f){this._toggleChecked(true);this._trigger("checkAll")},uncheckAll:function(){this._toggleChecked(false);this._trigger("uncheckAll")},getChecked:function(){return this.menu.find("input").filter(":checked")},destroy:function(){b.Widget.prototype.destroy.call(this);d.unbind(this._namespaceID);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},getButton:function(){return this.button},position:function(){var e=this.options;if(b.ui.position&&!b.isEmptyObject(e.position)){e.position.of=e.position.of||this.button;this.menu.show().position(e.position).hide()}else{var f=this.button.offset();this.menu.css({top:f.top+this.button.outerHeight(),left:f.left})}},_setOption:function(e,f){var g=this.menu;switch(e){case"header":g.find("div.ui-multiselect-header")[f?"show":"hide"]();break;case"checkAllText":g.find("a.ui-multiselect-all span").eq(-1).text(f);break;case"uncheckAllText":g.find("a.ui-multiselect-none span").eq(-1).text(f);break;case"height":g.find("ul").last().height(parseInt(f,10));break;case"minWidth":this.options[e]=parseInt(f,10);this._setButtonWidth();this._setMenuWidth();break;case"selectedText":case"selectedList":case"noneSelectedText":this.options[e]=f;this.update();break;case"classes":g.add(this.button).removeClass(this.options.classes).addClass(f);break;case"multiple":g.toggleClass("ui-multiselect-single",!f);this.options.multiple=f;this.element[0].multiple=f;this.refresh();break;case"position":this.position()}b.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery);
